name: Build Veyon Step 1 - Configure (Python-free)

on:
  workflow_dispatch:
  push:
    branches: [ "*" ]

jobs:
  windows:
    runs-on: windows-2022

    steps:
    # 1️⃣ 拉取源码
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # 2️⃣ 配置 MSVC
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    # 3️⃣ 下载并解压 Qt 5.15.2 预编译 zip（官方 release）
    - name: Download Qt 5.15.2 (MSVC 2019) zip
      run: |
        powershell -Command "Invoke-WebRequest -Uri https://mirrors.tuna.tsinghua.edu.cn/qtproject/archive/qt/5.15/5.15.2/msvc2019_64/qt-opensource-windows-x86-5.15.2.zip -OutFile qt.zip"
        powershell -Command "Expand-Archive -Path qt.zip -DestinationPath C:\Qt\5.15.2"


    # 4️⃣ 设置 Qt 环境变量
    - name: Set Qt Environment
      run: |
        echo "C:\Qt\5.15.2\5.15.2\msvc2019_64\bin" >> $env:GITHUB_PATH
        setx Qt5_DIR "C:\Qt\5.15.2\5.15.2\msvc2019_64\lib\cmake\Qt5"

    # 5️⃣ 验证环境
    - name: Show environment
      run: |
        echo %PATH%
        where cl
        cmake --version
        qmake -version

    # 6️⃣ 创建构建目录并配置 CMake
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -G "Visual Studio 16 2019" -A x64 -DVEYON_BUILD_WIN32=ON
